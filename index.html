<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body>

    <p><a class="show-new-tweets hide" href="#">Show <span class="new-tweet-counter"></span> new tweets</a></p>

    <div class="feed"></div>


    <script>

      $(document).ready(function(){
        var $body = $('body');
        var $feedDiv = $('.feed');
        var feed = streams.home;
        var numTweetsDisplayed = streams.home.length;

        // Format tweet, add event listener, add to feed
        var addToFeed = function(tweet) {
          var $tweetDiv = $('<div class="tweet"></div>');

          $tweetDiv.append(
            '<p><a class="link-username" href="#">@' + tweet.user + '</a></p>' +
            '<p>' + tweet.message + '</p>' +
            '<p>' + tweet.created_at + '</p>'
          );

          $tweetDiv.find('.link-username').on('click', function(event) {
            event.stopPropagation();
            event.preventDefault();
            
            feed = streams.users[tweet.user];
            renderFeed();
          });

          $tweetDiv.prependTo($feedDiv);
        };

        // Update counter that shows number of tweets not displayed yet
        var updateNewTweetCounter = function(numNewTweets) {
          if ($('.show-new-tweets').hasClass('hide')) {
            $('.show-new-tweets').removeClass('hide');
            $('.show-new-tweets').on('click', showNewTweets);
          }

          var s = (numNewTweets > 1) ? 's' : '';
          var counterText = 'Show ' + numNewTweets + ' new tweet' + s;
          $('.show-new-tweets').text(counterText);
        };

        // Check if there are any new tweets that aren't displayed yet
        var checkForNewTweets = function() {
          var numNewTweets = feed.length - numTweetsDisplayed;

          if (numNewTweets > 0) {
            updateNewTweetCounter(numNewTweets);
          }
        };

        // Show new tweets
        var showNewTweets = function() {
          // Determine how many tweets are hidden
          var streamLen = feed.length;
          var numNewTweets = streamLen - numTweetsDisplayed;

          // Loop through hidden tweets...
          for (var i = numTweetsDisplayed; i < streamLen; i++) {
            var tweet = feed[i];
            addToFeed(tweet);
          }

          // Update global var
          numTweetsDisplayed += numNewTweets;

          // Hide "show new tweets" link
          $('.show-new-tweets').addClass('hide');
        };


        // Render home or user feed
        var renderFeed = function() {
          $feedDiv.html('');

          var feedLen = feed.length;
          var index = feedLen - 1;

          while(index >= 0){
            var tweet = feed[index];
            addToFeed(tweet);
            index -= 1;
          };

          numTweetsDisplayed = feedLen;
          $('.show-new-tweets').addClass('hide');
        };

        // Initial feed render (home)
        renderFeed();

        // Auto-check for new tweets
        setInterval(function() {
          checkForNewTweets();
        });

      });


    </script>

  </body>
</html>
